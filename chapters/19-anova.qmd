# Analysis of Variance {#sec-anova}

```{r}
#| echo: false
#| message: false
library(tidyverse)
theme_set(theme_minimal())
```

## Beyond Two Groups

The t-test compares two groups, but many experiments involve more than two. We might compare three drug treatments, five temperature conditions, or four genetic strains. Running multiple t-tests creates problems: with many comparisons, false positives become likely even when no true differences exist.

Analysis of Variance (ANOVA) provides a solution. It tests whether any of the group means differ from the others in a single test, controlling the overall Type I error rate.

## The ANOVA Framework

ANOVA partitions the total variation in the data into components: variation between groups (due to treatment effects) and variation within groups (due to random error).

![](../images/Images_5b.016.jpeg){fig-align="center"}

The key insight is that if groups have equal means, the between-group variation should be similar to the within-group variation. If the between-group variation is much larger, the group means probably differ.

![](../images/Images_5b.015.jpeg){fig-align="center"}

## The F-Test

ANOVA uses the F-statistic:

$$F = \frac{MS_{between}}{MS_{within}} = \frac{\text{Variance between groups}}{\text{Variance within groups}}$$

Under the null hypothesis (all group means equal), F follows an F-distribution. Large F values indicate that group means differ more than expected by chance.

## One-Way ANOVA in R

```{r}
# Example using iris data
iris_aov <- aov(Sepal.Length ~ Species, data = iris)
summary(iris_aov)
```

The significant p-value tells us that sepal length differs among species, but not which species differ from which.

## ANOVA Assumptions

Like the t-test, ANOVA assumes:

1. **Normality**: Observations within each group are normally distributed
2. **Homogeneity of variance**: Groups have equal variances
3. **Independence**: Observations are independent

ANOVA is robust to mild violations of normality, especially with balanced designs and large samples. Serious violations of homogeneity of variance are more problematic but can be addressed with Welch's ANOVA or transformations.

## Post-Hoc Comparisons

A significant ANOVA tells us groups differ but not how. **Post-hoc tests** compare specific pairs of groups while controlling for multiple comparisons.

**Tukey's HSD** (Honestly Significant Difference) compares all pairs:

```{r}
TukeyHSD(iris_aov)
```

Each pairwise comparison includes the difference in means, confidence interval, and adjusted p-value.

## Planned Contrasts

If you have specific hypotheses about which groups should differ (decided before seeing the data), planned contrasts are more powerful than post-hoc tests. They focus statistical power on the comparisons you care about.

```{r}
# Example: Compare setosa to the average of the other two species
contrasts(iris$Species) <- cbind(
  setosa_vs_others = c(2, -1, -1)
)
summary.lm(aov(Sepal.Length ~ Species, data = iris))
```

## Fixed vs. Random Effects

**Fixed effects** are specific treatments of interest that would be the same if the study were replicated—drug A, drug B, drug C. Conclusions apply only to these specific treatments.

**Random effects** are levels sampled from a larger population—particular subjects, batches, or locations. The goal is to generalize to the population of possible levels, not just those observed.

The distinction matters because it affects how F-ratios are calculated and what conclusions can be drawn.

## Two-Way ANOVA

When experiments have two factors, two-way ANOVA examines main effects of each factor and their interaction.

```{r}
#| fig-width: 7
#| fig-height: 5
# Simulated factorial design
set.seed(42)
n <- 20
data_factorial <- data.frame(
  response = c(rnorm(n, 10, 2), rnorm(n, 12, 2), 
               rnorm(n, 11, 2), rnorm(n, 18, 2)),
  factor_A = rep(c("A1", "A1", "A2", "A2"), each = n),
  factor_B = rep(c("B1", "B2", "B1", "B2"), each = n)
)

two_way <- aov(response ~ factor_A * factor_B, data = data_factorial)
summary(two_way)
```

An **interaction** means the effect of one factor depends on the level of the other. Significant interactions often require examining simple effects rather than main effects.

## Interaction Plots

```{r}
#| fig-width: 7
#| fig-height: 5
# Visualize interaction
interaction.plot(data_factorial$factor_A, data_factorial$factor_B, 
                 data_factorial$response,
                 col = c("blue", "red"), lwd = 2,
                 xlab = "Factor A", ylab = "Response",
                 trace.label = "Factor B")
```

Non-parallel lines suggest an interaction. Parallel lines suggest additive (non-interacting) effects.

![](../images/images_7a.022.jpeg){fig-align="center"}

## Nested Designs

In nested designs, levels of one factor exist only within levels of another. For example, technicians might be nested within labs—each technician works in only one lab.

Nested designs have no interaction term because not all combinations of factor levels exist. They are common when sampling is hierarchical.

## Practical Considerations

Report effect sizes (like $\eta^2$) alongside p-values. A significant ANOVA with tiny effect size may not be practically meaningful.

Check assumptions with residual plots. Consider transformations or nonparametric alternatives (Kruskal-Wallis) when assumptions are violated.

Plan your sample size using power analysis before collecting data, specifying the minimum effect size you want to detect.

## ANOVA as a General Linear Model

ANOVA is a special case of the general linear model (GLM). Both t-tests and ANOVA can be expressed as regression with indicator variables (dummy coding). This unified framework shows that these seemingly different methods are fundamentally the same.

```{r}
# ANOVA using lm() with dummy coding
# Equivalent to aov()
iris_lm <- lm(Sepal.Length ~ Species, data = iris)
anova(iris_lm)
```

The connection becomes clear when you realize:
- A one-sample t-test is regression on an intercept
- A two-sample t-test is regression with one binary predictor
- One-way ANOVA is regression with multiple indicator variables

This unified view is powerful: once you understand regression, you understand the entire family of linear models.

## Effect Sizes in ANOVA

Beyond statistical significance, report how much of the variance is explained by your factors.

**Eta-squared ($\eta^2$)**: Proportion of total variance explained by the factor

$$\eta^2 = \frac{SS_{between}}{SS_{total}}$$

**Partial eta-squared ($\eta^2_p$)**: Proportion of variance explained after accounting for other factors

**Omega-squared ($\omega^2$)**: Less biased estimate of variance explained in the population

```{r}
# Calculate effect sizes
ss <- summary(iris_aov)[[1]]
ss_between <- ss["Species", "Sum Sq"]
ss_within <- ss["Residuals", "Sum Sq"]
ss_total <- ss_between + ss_within

eta_squared <- ss_between / ss_total
cat("Eta-squared:", round(eta_squared, 3), "\n")

# Omega-squared (less biased)
ms_within <- ss["Residuals", "Mean Sq"]
n <- nrow(iris)
k <- length(unique(iris$Species))
omega_squared <- (ss_between - (k-1) * ms_within) / (ss_total + ms_within)
cat("Omega-squared:", round(omega_squared, 3), "\n")
```

## Pseudoreplication

::: {.callout-warning}
## A Common Design Flaw

**Pseudoreplication** occurs when non-independent observations are treated as independent replicates. This inflates the apparent sample size and leads to artificially small p-values.

Common examples:
- Multiple measurements from the same individual treated as independent
- Multiple cells from the same culture dish
- Multiple fish from the same tank when treatment was applied to tanks
- Technical replicates confused with biological replicates
:::

The unit of replication must be the unit to which the treatment was independently applied. If you treat three tanks with drug A and three with drug B, you have n=3 per group regardless of how many fish are in each tank.

```{r}
# Wrong: treats individual fish as independent
# If 10 fish per tank, and tanks are the true units:
set.seed(42)
# This overstates the evidence because fish within tanks are correlated
tank_A <- rep(c(10, 12, 11), each = 10) + rnorm(30, sd = 1)  # 3 tanks, 10 fish each
tank_B <- rep(c(8, 9, 8.5), each = 10) + rnorm(30, sd = 1)

# Pseudoreplicated analysis (WRONG - n appears to be 30 per group)
cat("Pseudoreplicated p-value:", t.test(tank_A, tank_B)$p.value, "\n")

# Correct analysis (using tank means, n = 3 per group)
means_A <- c(mean(tank_A[1:10]), mean(tank_A[11:20]), mean(tank_A[21:30]))
means_B <- c(mean(tank_B[1:10]), mean(tank_B[11:20]), mean(tank_B[21:30]))
cat("Correct p-value:", t.test(means_A, means_B)$p.value, "\n")
```

The correct analysis has less power (larger p-value) because it honestly reflects the true sample size.

## Repeated Measures ANOVA

When the same subjects are measured under multiple conditions, observations are not independent—each subject creates correlated measurements. **Repeated measures ANOVA** accounts for this by partitioning out between-subject variability.

```{r}
# Simulated repeated measures data
set.seed(123)
n_subjects <- 10
subject <- factor(rep(1:n_subjects, 3))
time <- factor(rep(c("Before", "During", "After"), each = n_subjects))

# Subjects have baseline differences, plus time effect
baseline <- rnorm(n_subjects, 50, 10)
response <- c(baseline, baseline + 5 + rnorm(n_subjects, 0, 3),
              baseline + 2 + rnorm(n_subjects, 0, 3))

rm_data <- data.frame(subject, time, response)

# Repeated measures ANOVA
rm_aov <- aov(response ~ time + Error(subject/time), data = rm_data)
summary(rm_aov)
```

Repeated measures designs are powerful because they control for individual differences, but require additional assumptions (sphericity) that should be checked.

## Summary

ANOVA provides a flexible framework for comparing groups:

- One-way ANOVA compares means across multiple groups
- The F-test assesses whether between-group variance exceeds within-group variance
- Post-hoc tests identify which specific groups differ
- Two-way ANOVA examines main effects and interactions
- Fixed effects are specific treatments; random effects are sampled from populations
- ANOVA is part of the general linear model family
- Always report effect sizes, not just p-values
- Beware of pseudoreplication—the unit of analysis must match the unit of replication

## Additional Resources

- @logan2010biostatistical - Comprehensive treatment of ANOVA designs in biological research
- @crawley2007r - Detailed coverage of linear models in R including ANOVA
